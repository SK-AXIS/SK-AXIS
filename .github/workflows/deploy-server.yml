name: Deploy Server Service

on:
  push:
    branches: [ back ]  # 'back' 브랜치에 푸시할 때 실행
    paths:
      - 'server/**'

jobs:
  build-and-deploy-server:
    runs-on: ubuntu-latest
    environment: deploy
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and push Server image
      run: |
        docker buildx build --platform linux/amd64 \
          -t ${{ secrets.DOCKER_USERNAME }}/skaxis-server:latest \
          --push ./server/spring
          
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        script: |
          echo "=== SK-AXIS 업데이트 시작 ==="
          
          # 최신 이미지 풀
          echo "최신 이미지 다운로드 중..."
          docker pull --platform linux/amd64 ${{ secrets.DOCKER_USERNAME }}/skaxis-server:latest
          
          # 서비스 재시작 (데이터베이스는 유지)
          echo "애플리케이션 서비스 재시작 중..."
          docker-compose down springboot || true
          docker-compose up -d springboot
          
          # 사용하지 않는 이미지 정리
          docker image prune -f
          
          echo "=== 업데이트 완료! ==="
          docker-compose ps
